<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="shortcut icon" type="image/png" href="../img/icon-72x72.png">
    <link rel="shortcut icon" type="image/png" href="../img/icon-96x96.png">
    <link rel="shortcut icon" type="image/png" href="../img/icon-128x128.png">
    <link rel="shortcut icon" type="image/png" href="../img/icon-144x144.png">
    <link rel="shortcut icon" type="image/png" href="../img/icon-152x152.png">
    <link rel="shortcut icon" type="image/png" href="../img/icon-167x167.png">
    <link rel="shortcut icon" type="image/png" href="../img/icon-180x180.png">
    <link rel="shortcut icon" type="image/png" href="../img/icon-192x192.png">
    <style>
/* *** GLOBAL MARGIN/PADDING RESET (AGGRESSIVE) *** */
html, body {
    padding: 0 !important; /* Force all padding to zero */
    margin: 0 !important; /* Force all margin to zero */
    box-sizing: border-box; 
    width: 100%;
    overflow-x: hidden; /* Prevents horizontal scrollbar */
    /* *** FIX: Ensure vertical scrolling on the entire page and allow collapse *** */
    overflow-y: scroll;
    min-height: 100%; /* Allow shrinking */
    height: auto;
}
/* **************************************** */


/* Default styles (for larger screens like desktops) */
#content {
    position: relative;
    z-index: 1; /* content above blur */
    overflow-y: visible; /* Let the body/document handle scrolling */
    /* ðŸ’¥ FIX 1: Allow content to dictate height */
    min-height: auto; 
    height: auto; 
    padding: 20px; /* Default desktop padding */
    flex: 1; 
}


#content::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    /* ðŸ’¥ CRITICAL FIX 2: Set height to 100% of content, not 160% */
    height: 100%;
    background: url("../img/shaadhi.png") no-repeat center center/cover;
    filter: blur(10px);
    opacity: 0.85;
    z-index: -1;
    border-radius: 10px;
}


.dashboard-content {
    position: relative;
    z-index: 2;
}

.option-button {
    padding: 8px 10px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    background-color: #f5e7df;
    color:grey;
    transition: all 0.3s ease;
    font-weight: 500;
}

.icon-row {
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 8px 10px;
}

.icon-row1 {
    width: 100%;
    border-radius: 12px;
    border: 2px solid #f5e7df;
    background: linear-gradient(135deg, #f5e7df 0%, #f5e7df 100%);
}

/* ðŸš© COLOR FIX 1: My Profile Title Color */
.profile h2 {
    font-size: 1.8rem;
    color: #cc2114; /* Updated color */
    margin-bottom: 1rem;
    font-family: 'Playfair Display', serif;
}
/* ðŸš© COLOR FIX 2: Matri Id Text Color */
.icon-row h2 {
    color: #cc2114; /* Updated color */
}

/* ðŸš© SYMBOL COLOR FIX: Back arrow in the title */
.profile h2 .fa-arrow-left {
    color: #cc2114 !important; /* Updated color */
    border: 1px solid #cc2114 !important; /* Update border color for consistency */
}

/* Base Desktop Sidebar Styles */
#sidebar-placeholder {
    width: 280px;
    background: linear-gradient(180deg, #f5e7df 0%, #f5e7df 100%);
    color: #2c3e50;
    border-right: 1px solid #e3f2fd;
    /* Ensure default desktop behavior (relative to flex container) */
    position: relative; 
    height: auto;
    min-height: auto;
    flex-shrink: 0; 
}

.sidebar {
    width: 280px;
    background: linear-gradient(180deg, #f5e7df 0%, #f5e7df 100%);
    padding: 1.5rem;
    border-right: 1px solid #e3f2fd;
    box-shadow: 4px 0 15px rgba(33, 150, 243, 0.1);
    height: auto;
    min-height: auto; 
    }

.profile-basic {
    max-width: 600px;
    margin: 20px auto;
    padding: 5px;
    background: #f9f9f9;
    font-family: Arial, sans-serif;
    }
    .profile-item1 {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
    }
    .profile-label1 {
    flex: 2;
    font-weight: bold;
    color: #333;
    }
    .profile-item1 span {
    flex: 2;
    color: #555;
    text-align: left;
    margin-left: 20px;
    
        word-break: break-all;
        word-wrap: break-word;
    }
    .option-button {
    margin-bottom: 20px;
    }
    p {
    display: flex;
    align-items: center;
    }
    
    #dob {
    display: flex;
    justify-content: space-between;
    width: 100%;
    align-items: center;
    }
    
    .option-button {
    display: flex;
    flex: 2;
    align-items: right;
    margin-left: auto;
    }


.toggle-btn {
    display: none;
}
/* ... (profile-basic, profile-item1, etc. repeated styles consolidated above) ... */

/* âœ… Responsive Adjustments */
@media (max-width: 768px) {
    /* 1. Reset Dashboard Container spacing and height limits */
    .dashboard-container {
        padding: 0 !important; 
        margin: 0 !important; 
        min-height: auto !important;
        height: auto !important;
        display: block; 
    }
    
    /* 2. Minimized padding on the main content wrapper (#content) */
    #content {
        padding-left: 2px !important; 
        padding-right: 2px !important;
        padding-top: 40px !important; /* Added space for the toggle button */
        min-height: auto !important;
        height: auto !important;
    }
    
    /* Ensure sidebar placeholders collapse when hidden */
    #sidebar-placeholder, .sidebar {
        min-height: auto !important;
        height: auto !important;
    }

    /* ðŸ’¥ FIX: Change profile-left to flex container and manage order */
    .profile-left {
        order: 2; 
        display: flex;
        flex-direction: column;
        /* Reduced gap to tighten spacing */
        gap: 5px; 
    }

    /* ðŸ”¥ FIX 1: Set order for the sections within profile-left */
    .profile-left h2 {
        order: 0; /* Title first */
        margin-bottom: 5px; /* Reduced gap below title */
    }
    .profile-left p {
        order: 1; /* Basic info second */
        margin: 2px 0; /* Reduced vertical margin for p elements */
    }
    .more-section {
        order: 2; /* Options row section third (the toggle button and dropdown) */
        width: 100%;
        /* Reduced vertical space around the toggle/dropdown area */
        margin: 5px 0; 
    }
    #detailsSection {
        /* ðŸ”¥ FIX 2: Set the main content section to appear below the dropdown */
        order: 3; /* Details content fourth */
        width: 100%;
    }

    .profile-basic {
        /* 3. Force content card to use full available space */
        max-width: 100% !important; 
        padding: 5px;
        margin: 5px auto; /* Reduced margin */
    }

    .profile-item1 {
        flex-direction: column; /* stack label + value */
        align-items: flex-start;
        padding: 5px 0; /* Reduced padding */
    }

    .profile-item1 span {
        margin-left: 0;
        margin-top: 2px; /* Reduced margin */
        text-align: left;
        width: 100%;
    }

    #dob {
        flex-direction: column; 
        align-items: flex-start;
        gap: 5px; /* Reduced gap */
    }

    .option-button {
        justify-content: center;
        margin-left: 0;
        margin-top: 5px; /* Reduced margin */
    }
}

@media (max-width: 480px) {
    .dashboard-container {
        padding: 0 !important;
        margin: 0 !important;
        min-height: auto !important; 
        height: auto !important;
    }
    
    #content {
        padding-left: 2px !important;
        padding-right: 2px !important;
        padding-top: 40px !important;
        min-height: auto !important;
        height: auto !important;
    }
    
    #sidebar-placeholder {
        min-height: auto !important;
        height: auto !important;
    }

    .profile-basic {
        max-width: 100% !important; 
        padding: 5px;
    }

    .profile-label1 {
        font-size: 14px;
    }

    .profile-item1 span {
        font-size: 14px;
    }

    .option-button {
        width: 100%;
        justify-content: center;
    }
}

/* shetty - General Container and Layout */
.dashboard-container {
    display: flex;
    max-width: 1600px;
    width: 100%;
    margin: 0 auto;
    min-height: auto;
    height: auto;
}

.sidebar h3 {
    margin-top: 0;
}

.profile-container {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

.profile-left, .profile-right {
    flex: 1;
    min-width: 280px;
}

/* Responsive (max-width: 1024px) - For tablet/larger mobile */
@media (max-width: 1024px) {
    .dashboard-container {
        flex-direction: column;
        min-height: auto;
        height: auto;
    }
    
    #sidebar-placeholder {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #e3f2fd;
        min-height: auto; 
        height: auto;
        position: relative; 
    }
    
    .profile-container {
        flex-direction: column;
    }
    
    .profile-left, .profile-right {
        min-width: 100%;
    }
}


/* *** FIX: Mobile Sidebar Positioning (max-width: 768px) *** */
@media screen and (max-width: 768px) {
    /* ... (Sidebar positioning remains unchanged) ... */
    #sidebar-placeholder {
        position: fixed;
        top: 0;
        left: -280px; 
        width: 280px; 
        height: 100vh; 
        min-height: 100vh !important;
        background: #f5e7df;
        transition: left 0.3s ease;
        z-index: 10000;
        border-right: none;
        box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2);
    }
    
    #sidebar-placeholder.open {
        left: 0;
    }

    .toggle-btn {
        display: block;
        position: fixed;
        top: 2px;
        left: 10px;
        z-index: 11000; 
        background: #c3a38c;
        color: white;
        border: none;
        padding: 5px 5px;
        font-size: 20px;
        border-radius: 6px;
        cursor: pointer;
    }
    
    /* Optional mobile cleanup */
     #sidebar-placeholder.open h3.container-header1,
     #sidebar-placeholder.open hr.container-header1 {
         display: none;
     }

     #sidebar-placeholder.open ul {
         margin-top: 25px;
     }
}
/* *** END FIX: Mobile Sidebar Positioning *** */


/* âœ… Default - Desktop view for Options Row */
.options-row {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px;
    background-color: white;
    transition: all 0.3s ease-in-out;
}

/* âœ… Buttons */
.option-button {
    background: #c3a38c;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.3s;
}

.option-button:hover {
    background: #c3a38c;
}

/* âœ… Hamburger (hidden on desktop) */
.mobile-menu-icon {
    display: none;
    font-size: 24px;
    cursor: pointer;
    padding: 5px 10px; /* Adjusted padding */
    margin: 0; /* Removed margin */
}

/* âœ… Responsive (mobile) - Options Dropdown */
@media (max-width: 768px) {
    .mobile-menu-icon {
        display: block;
        align-self: flex-start;
        position: relative;
        left: 0;
        top: 0;
        /* Add margin to separate the icon from the options when dropdown is closed */
        margin-bottom: 5px; 
    }

    .options-row {
        display: none !important; /* hidden by default on mobile */
        flex-direction: column;
        align-items: flex-start;
        background-color: white;
        /* ðŸ”¥ CRITICAL FIX: Change position from absolute to relative to keep it in the document flow */
        position: relative; 
        top: auto; 
        left: auto; 
        width: 98%; 
        margin: 0 auto; 
        padding: 5px; /* ðŸ”¥ Reduced padding around the entire dropdown */
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 999;
        gap: 0; /* ðŸ”¥ Removed gap between buttons in the flex column */
        margin-bottom: 10px;
    }
    
    /* ðŸ”¥ Tighter spacing for buttons inside the dropdown */
    .options-row .option-button {
        width: 100%;
        margin: 2px 0; /* Minimal vertical margin between buttons */
        padding: 6px 10px;
    }

    .options-row.show {
        display: flex !important;
    }
}


/* On mobile, show .profile-right above .profile-left */
@media (max-width: 768px) {
    .profile-container {
        flex-direction: column; /* stack vertically */
    }

    .profile-left {
        order: 2; /* comes after .profile-right */
    }

    .profile-right {
        order: 1; /* comes first */
        margin-bottom: 15px; /* optional spacing */
    }
}
</style>
<body>

    <div id="navbar-placeholder"></div>

    <div class="dashboard-container">
        <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>
           <div id="sidebar-placeholder"></div>


        <main id="content" class="content">
            <div id="waiting-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 9999;">
                <div style="background-color: #f5e7df; padding: 20px; border-radius: 8px;">
                    <div class="loader" style="border: 4px solid #f3f3f3; border-top: 4px solid #c3a38c; border-radius: 50%; width: 50px; height: 50px; animation: spin 2s linear infinite;"></div>
                    <p style="text-align: center; margin-top: 10px;">Please Wait...</p>
                </div>
            </div>
            
            <section class="profile">
                <div class="profile-container">
                    <div class="profile-left profile-details">
                        <h2><i class="fa fa-arrow-left" style="color:#c3a38c;border:1px solid black;border-radius: 50%;padding:5px;margin-right: 15px;" onclick="goBack()"></i>My Profile</h2>
                        <p><span class="labelStar"><strong>Name:</strong></span> <span id="profileNameText"></span></p>
                        <p><span class="labelStar"><strong>Age:</strong></span><span id="profileAge"></span></p>
                        <p><span class="labelStar"><strong>Height:</strong></span> <span id="profileHeight"></span></p>
                        <p><span class="labelStar"><strong>Weight:</strong></span> <span id="profileWeight"></span></p>
                        <div class="more-section" id="more">
                            
<div class="mobile-menu-icon" onclick="toggleOptions()">â˜°</div>

<div id="optionsRow" class="options-row">
  <button class="option-button" data-section="basic">Basic</button>
  <button class="option-button" data-section="additional">Additional</button>
  <button class="option-button" data-section="education">Education</button>
  <button class="option-button" data-section="horoscope">Horoscope</button>
  <button class="option-button" data-section="family">Family</button>
  <button class="option-button" data-section="photo">Photo</button>
  <button class="option-button" data-section="delete">Profile Status</button>
</div>

                        </div>
                        <div id="detailsSection" class="details-section profile-details">
                            </div>
                    </div>
                    <div class="profile-right">
                        <div class="icon-row1">
                            <img id="profilePhoto" alt="User Photo" class="profile-photo">
                            <div class="icon-row">
                                <h2>Matri Id&nbsp;:&nbsp;<span id="matriText"></span></h2> 
                            </div>
                        </div>
                    </div>
                </div>
              

                <div id="zoomModal" class="zoom-modal" style="display: none;">
                    <div class="zoom-modal-content">
                        <span id="closeZoom" class="close-zoom">&times;</span>
                        <img id="zoomedImage" class="zoomed-image" src="" alt="Zoomed Image">
                    </div>
                </div>
            </section>
        </main>
    </div>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="baseurl.js"></script>
    <script>
// =========================================================================
// MISSING GLOBAL FUNCTION RESTORATION & INITIALIZATION
// =========================================================================
let myProfileNew = [];
let photos_url = []; // ðŸ’¡ FIX 1: Initialize global photo array to prevent errors

function toggleOptions() {
    document.getElementById("optionsRow").classList.toggle("show");
}

/* *** FIX: Corrected toggleSidebar function *** */
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar-placeholder');
    // Toggle the 'open' class on the sidebar placeholder
    sidebar.classList.toggle('open');
    
    // Optionally close the options dropdown if open when sidebar is toggled
    const optionsRow = document.getElementById("optionsRow");
    if (window.innerWidth <= 768 && optionsRow.classList.contains("show")) {
        optionsRow.classList.remove("show");
    }
}
/* ******************************************* */

function openPageAndPostMessage() {
    if (typeof myProfileNew !== "undefined" && myProfileNew !== null) {
        sessionStorage.setItem("formData", JSON.stringify(myProfileNew));
        window.location.href = "EditRegister";
    } else {
       console.error("myProfileNew is not defined or empty for basic edit.");
    }
}
function openEditAdditional(){
    if (typeof myProfileNew !== "undefined" && myProfileNew !== null) {
        sessionStorage.setItem("formData", JSON.stringify(myProfileNew));
        window.location.href = "EditAdditionalDetail";
    } else {
       console.error("myProfileNew is not defined or empty for additional edit.");
    }
}
function openEditEducation(){
    if (typeof myProfileNew !== "undefined" && myProfileNew !== null) {
        sessionStorage.setItem("formData", JSON.stringify(myProfileNew));
        window.location.href = "EditEducation";
    } else {
       console.error("myProfileNew is not defined or empty for education edit.");
    }
}
function openEditHoroscope(){
    if (typeof myProfileNew !== "undefined" && myProfileNew !== null) {
        sessionStorage.setItem("formData", JSON.stringify(myProfileNew));
        window.location.href = "EditHoroscope";
    } else {
       console.error("myProfileNew is not defined or empty for horoscope edit.");
    }
}
function openEditFamily(){
    if (typeof myProfileNew !== "undefined" && myProfileNew !== null) {
        sessionStorage.setItem("formData", JSON.stringify(myProfileNew));
        window.location.href = "EditFamily";
    } else {
       console.error("Edit family is not defined or empty.");
    }
}
function openEditPhoto(){
    if (typeof myProfileNew !== "undefined" && myProfileNew !== null) {
        sessionStorage.setItem("formData", JSON.stringify(myProfileNew));
        window.location.href = "EditPhoto";
    } else {
       console.error("Edit family is not defined or empty.");
    }
}

// =========================================================================
// END OF GLOBAL FUNCTION RESTORATION
// =========================================================================

function loadHTMLContent(elementId, url, callback) {
    fetch(url)
        .then(response => response.text())
        .then(data => {
            document.getElementById(elementId).innerHTML = data;
            if (callback) callback(); // Execute callback after content is loaded
        })
        .catch(error => console.error('Error loading HTML:', error));
}
// Load Navbar and Sidebar
loadHTMLContent('navbar-placeholder', 'navbar');
loadHTMLContent('sidebar-placeholder', 'sidebar', function () {
    // Add event listeners after the sidebar content is loaded
    const menus = document.querySelectorAll('.matches-menu');

    menus.forEach(menu => {
        menu.addEventListener('click', function (event) {
            // Prevent default behavior only for parent menu links
            if (!event.target.closest('.submenu a')) {
                event.preventDefault();
            }

            // Check if the clicked element has a submenu
            const submenu = this.querySelector('.submenu');

            // If the submenu exists, toggle its visibility
            if (submenu) {
                const isVisible = submenu.style.display === 'block';

                // Close all submenus
                document.querySelectorAll('.submenu').forEach(s => {
                    s.style.display = 'none';
                });

                // Toggle only the clicked submenu
                submenu.style.display = isVisible ? 'none' : 'block';
            }
        });
    });

    // Add listeners to submenu links to ensure navigation works
    const submenuLinks = document.querySelectorAll('.submenu a');
    submenuLinks.forEach(link => {
        link.addEventListener('click', function (event) {
           //consolelog(`Navigating to ${this.getAttribute('href')}`);
        });
    });
});

function toggleProfileDropdown() {
    const dropdown = document.getElementById('profileDropdown');
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';

    // Attach a click event listener to close the dropdown when clicking outside
    if (dropdown.style.display === 'block') {
        document.addEventListener('click', closeDropdownOnClickOutside);
    }
}

// Close the dropdown on outside click
function closeDropdownOnClickOutside(event) {
    const dropdown = document.getElementById('profileDropdown');
    const profileIcon = document.querySelector('.profile-icon');

    // Check if the clicked element is outside the dropdown or profile icon
    if (!dropdown.contains(event.target) && !profileIcon.contains(event.target)) {
        dropdown.style.display = 'none';
        document.removeEventListener('click', closeDropdownOnClickOutside); // Clean up the event listener
    }
}


function logout() {
    //consolelog("User logged out");
    localStorage.clear();
    localStorage.setItem("visitedSuccessPage", "true");
    window.location.href = 'Login';
}
// "More" Button Functionality

const moreButton = document.getElementById("moreButton");
const optionsRow = document.getElementById("optionsRow");
const detailsSection = document.getElementById("detailsSection");


document.querySelectorAll(".option-button").forEach(button => {
    button.addEventListener('click', function () {
        const section = this.getAttribute("data-section");
        loadSectionDetails(section);

        // âœ… Close dropdown automatically on mobile
        const optionsRow = document.getElementById("optionsRow");
        if (window.innerWidth <= 768) {
            optionsRow.classList.remove("show");
        }
    });
});


function toggleLike(element) {
    const icon = element.querySelector('i'); // Get the icon inside the clicked element

    // Toggle the classes for the heart icon
    icon.classList.toggle('fa-heart'); // Outline class
    icon.classList.toggle('fa-heart-o'); // Filled class (or vice versa)
    icon.style.color = icon.classList.contains('fa-heart-o') ? '#d0afaf' : 'red';

    // Set the color based on the toggled class
    if (icon.classList.contains('fa-heart')) {
        icon.style.color = 'red'; // If heart is filled, make it red
    } else if (icon.classList.contains('fa-heart-o')){
        icon.style.color = '#d0afaf'; // Reset the color when unliked
    }else {
        icon.style.color = '#d0afaf'; // Reset the color when unliked
    }

    // You can also set a status type if needed
    const type = icon.classList.contains('fa-heart') ? 'liked' : 'disliked';
    const data={
        "matri_id_by": localStorage.getItem('matriId'),
        "matri_id_to": localStorage.getItem("matriIdTo"),
        "type": type
    }
   //consolelog(data);
    axios.post(`${BASE_URL}/matri_liked.php`, data, {
headers: {
    'Content-Type': 'application/json',
    "Authorization": "Bearer " + localStorage.getItem("jwtToken")
}
})
.then(function (response) {
// âœ… Check if backend says token expired or invalid
if (response.data.token) {
            localStorage.setItem("jwtToken", response.data.token);
            console.log("new token",response.data.token);
        }
if (
    response.data.message?.p_out_mssg_flg === 'N' &&
    (response.data.message?.p_out_mssg?.includes('Token expired') ||
     response.data.message?.p_out_mssg?.includes('Invalid token'))
) {
    handleSessionExpiry();
    return;
}

if (response.data.message.p_out_mssg_flg === 'Y') {
    //console.log(response.data.dataout[0].viewed_count);
} else {
    //console.log(response.data.message.p_out_mssg_flg, "and", response.data.message.p_out_mssg);
}
})
.catch(function (error) {
// âœ… Handle unauthorized or token-related errors
if (error.response && error.response.status === 401) {
    handleSessionExpiry();
} else {
    Swal.fire({
        title: "Error!",
        text: "Something went wrong. Please try again.",
        icon: "error",
        confirmButtonText: "OK",
    });
}
});

// ðŸ”¹ Common session expiry handler (reusable)
function handleSessionExpiry() {
    Swal.fire({
        icon: "info",
        title: "Session Expired",
        text: "Your session has expired. Please log in again.",
        confirmButtonText: "OK",
    }).then(() => {
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("matriId");
        window.location.href = "Login";
    });
}
}

function contactInfoSection(){

    Swal.fire({
    // title: 'Creator Contact Info',
    html: `
        <h3 style="margin-bottom:10px;">Contact Information</h3>
        <div style="text-align: left;">
        <p><strong>Creator Phone No&nbsp;:</strong> ${localStorage.getItem("phone")}</p>
        <p><strong>Email Id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:</strong> ${localStorage.getItem("email")}</p>
        </div>
    `,
    // icon: 'info',
    confirmButtonText: 'Close',
    confirmButtonColor: '#3085d6',
    background: '#f7f7f7',
    customClass: {
        title: 'swal-title',
        htmlContainer: 'swal-html-container',
    },
    });

}

function chatInfoSection(){
    window.location.href = "chats";
}

function goBack() {
    history.back();
}

function getPhotoHTML(photoArray) {
    return photoArray.map(photoUrl => {
        return `
            <div class="photo-item" style="position: relative; display: inline-block; margin: 10px;">
                <img class="photo" src="${photoUrl.url}" alt="Photo" style="width: 150px; height: 150px; object-fit: cover; cursor: pointer;">
                <div class="edit-icon" 
                     style="position: absolute; top: 5px; right: 5px; background-color: rgba(0, 0, 0, 0.6); color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; cursor: pointer;" 
                     onclick="showPhotoOptions('${photoUrl.sl_id}')">
                     âœŽ
                </div>
            </div>
        `;
    }).join('');
}
function showPhotoOptions(photoId) {
    const popup = document.createElement('div');
    popup.style.position = 'fixed';
    popup.style.top = '50%';
    popup.style.left = '50%';
    popup.style.transform = 'translate(-50%, -50%)';
    popup.style.backgroundColor = 'white';
    popup.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
    popup.style.padding = '20px';
    popup.style.borderRadius = '8px';
    popup.style.zIndex = '1000';

    popup.innerHTML = `
        <p style="margin: 0 0 10px;">Choose an option:</p> 
        <button style="position: absolute; top: 5px; right: 5px; cursor: pointer; font-size: 16px;" onclick="closePopup()">âœ–</button > Â  Â  Â  Â  Â  
        <button style="margin: 5px; padding: 10px; cursor: pointer;" onclick="setAsProfilePhoto('${photoId}')">Set as Profile Photo</button>
        <button style="margin: 5px; padding: 10px; cursor: pointer;" onclick="deletePhoto('${photoId}')">Delete</button>
        
    `;

    document.body.appendChild(popup);
}


img=localStorage.getItem("baseURL")
function setAsProfilePhoto(photoId) {
    // Retrieve base URL from localStorage

   //consolelog('ll',photoId)
    // Extract unique sl_id for the selected photo (assume sl_id is part of photoUrl or data)
    const sl_id = photoId; // Replace with your logic to extract sl_id
    const matri_id =localStorage.getItem("matriId"); // Replace with the actual matri_id for the user
   //consolelog("m",matri_id)
    const data = {
        type: "profile",
        matri_id: matri_id,
        sl_id: sl_id
    };
   //consolelog("bhbj",data);

    call_api(data);

}


function swal_file(){
    Swal.fire({
        title: "Success!",
        text: "Profile photo updated successfully.",
        icon: "success",
        confirmButtonText: "OK"
    });


    Swal.fire({
        title: "Error!",
        text: "Failed to update profile photo.",
        icon: "error",
        confirmButtonText: "OK"
    });

}

async function call_api(data) {
try {
    const token = localStorage.getItem("jwtToken");

    if (!token) {
        await handleSessionExpiry();
        return;
    }

    const response = await axios.post(`${BASE_URL}/edit_image.php`, data, {
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        }
    });

    // âœ… If backend returns a new token, update it
    if (response.data && response.data.token) {
        localStorage.setItem("jwtToken", response.data.token);
        console.log("new token",response.data.token);
    }

    // âœ… Success message
    Swal.fire({
        title: "Success!",
        text: "Profile photo updated successfully.",
        icon: "success",
        confirmButtonText: "OK"
    }).then(() => {
        // Reload the page to show the new profile picture
        window.location.reload();
    });

    closePopup();

} catch (error) {
    console.error("Error:", error);

    // âœ… Handle unauthorized or expired session
    if (
        error.response &&
        (
            error.response.status === 401 ||
            (error.response.data && (
                error.response.data.message?.includes("expired") ||
                error.response.data.message?.includes("Invalid token")
            ))
        )
    ) {
        await handleSessionExpiry();
    } else {
        Swal.fire({
            title: "Error!",
            text: "Something went wrong. Please try again later.",
            icon: "error",
            confirmButtonText: "OK"
        });
    }
}
}
async function handleSessionExpiry() {
    if (window.sessionExpiredAlertShown) return;
    window.sessionExpiredAlertShown = true;

    await Swal.fire({
        title: "Session Expired",
        text: "Your session has expired. Please log in again.",
        icon: "warning",
        confirmButtonText: "OK",
        allowOutsideClick: false,
        allowEscapeKey: false
    });

    localStorage.removeItem('jwtToken');
    localStorage.removeItem('matriId');
    sessionStorage.clear();

    window.location.href = "login";
}

function deletePhoto(photoId) {
   //consolelog("Deleting photo with ID:", photoId);

    // Retrieve the necessary identifiers
    const matri_id = localStorage.getItem("matriId"); // Replace with the actual matri_id for the user
    const sl_id = photoId;
    // Create the payload
    const data = {
        type: "delet",
        matri_id: matri_id,
        sl_id: sl_id // Use the photoId passed to the function
    };
   //consolelog("Delete Payload:", data);

    // Make the API call
    call_delete_api(data);
}

async function call_delete_api(data) {
try {
    const token = localStorage.getItem("jwtToken");

    if (!token) {
        await handleSessionExpiry();
        return;
    }

    const response = await axios.post(`${BASE_URL}/edit_image.php`, data, {
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        }
    });

    // âœ… Refresh JWT token if new one is returned
    if (response.data && response.data.token) {
        localStorage.setItem("jwtToken", response.data.token);
    }

    closePopup();

    // âœ… Handle success/failure message
    const msgFlag = response.data.message?.p_out_mssg_flg || "N";
    const msgText = response.data.message?.p_out_mssg || "No message returned.";

    if (msgFlag === "Y") {
        Swal.fire({
            title: "Success!",
            text: "Photo deleted successfully.",
            icon: "success",
            confirmButtonText: "OK"
        }).then(() => {
            // Reload the page to refresh the photo list
            window.location.reload(); 
        });
    } else {
        Swal.fire({
            title: "Error!",
            text: msgText || "Failed to delete photo.",
            icon: "error",
            confirmButtonText: "OK"
        });
    }

} catch (error) {
    console.error("Error:", error);

    // âœ… Handle token expiry / unauthorized access
    if (
        error.response &&
        (
            error.response.status === 401 ||
            (error.response.data &&
                (
                    error.response.data.message?.includes("expired") ||
                    error.response.data.message?.includes("Invalid token")
                )
            )
        )
    ) {
        await handleSessionExpiry();
    } else {
        Swal.fire({
            title: "Error!",
            text: "Something went wrong. Please try again later.",
            icon: "error",
            confirmButtonText: "OK"
        });
    }
}
}

function closePopup() {
    const popup = document.querySelector('body > div[style*="z-index: 1000"]');
    if (popup) {
        document.body.removeChild(popup);
    }
}





// Function to initialize the zoom functionality
function initZoom() {
    const photos = document.querySelectorAll('.photo');
    const zoomModal = document.getElementById('zoomModal');
    const zoomedImage = document.getElementById('zoomedImage');
    const closeZoom = document.getElementById('closeZoom');

    // When any photo is clicked, show the zoomed-in version
    photos.forEach(photo => {
        photo.addEventListener('click', () => {
            zoomedImage.src = photo.src;    // Set the clicked image as the zoomed image
            zoomModal.style.display = 'flex';   // Show the modal
        });
    });

    // Close the zoom modal when the close button is clicked
    closeZoom.addEventListener('click', () => {
        zoomModal.style.display = 'none';   // Hide the modal
    });

    // Close the zoom modal when clicking anywhere outside the image
    window.addEventListener('click', (event) => {
        if (event.target === zoomModal) {
            zoomModal.style.display = 'none';   // Hide the modal if clicked outside
        }
    });
}


function myProfile() {
    const data = {
        matri_id: localStorage.getItem('matriId')
    };

    axios.post(`${BASE_URL}/my_profile.php`, data, {
        headers: {
            'Content-Type': 'application/json',
            "Authorization": "Bearer " + localStorage.getItem("jwtToken")
        }
    })
    .then(function(response) {
        const res = response.data;
if (res.token) {
          localStorage.setItem("jwtToken", res.token);
    }
        if (res.message && res.message.p_out_mssg_flg === 'Y') {
            const myProfile = res.dataout[0];
            console.log("MY profd",myProfile);
            myProfileNew = myProfile;
console.log("MY njfenjem",myProfileNew);
            // Update profile details safely
            document.getElementById("profileNameText").textContent =
                (myProfile.first_name && myProfile.first_name !== 'null'
                    ? myProfile.first_name + " " + myProfile.last_name
                    : '');

            document.getElementById("profileAge").textContent =
                (myProfile.age && myProfile.age !== 'null'
                    ? myProfile.age + " yrs"
                    : '');

            document.getElementById("profileHeight").textContent =
                (myProfile.height && myProfile.height !== 'null'
                    ? myProfile.height + " cm"
                    : '');

            document.getElementById("profileWeight").textContent =
                (myProfile.weight && myProfile.weight !== 'null'
                    ? myProfile.weight + " kg"
                    : '');

            // Handle profile image
            let imgURL = '';
            if (myProfile.gender_type === 'Male' && (!myProfile.url || myProfile.url === '')) {
                imgURL = '../img/2.png';
            } else if (myProfile.gender_type === 'Female' && (!myProfile.url || myProfile.url === '')) {
                imgURL = '../img/1.png';
            } else {
                imgURL = localStorage.getItem("baseURL") + myProfile.url;
            }
            document.getElementById("profilePhoto").src = imgURL;

            // Set matrimony ID
            document.getElementById("matriText").textContent = myProfile.matri_id;

        } else {
            console.error("Profile fetch failed:", res.message.p_out_mssg);
        }
    })
    .catch(function(error) {
        console.error("Error fetching profile:", error);

        // âœ… Check for token-related errors
        if (
            error.response &&
            (error.response.status === 401 ||
               (error.response.data &&
               (error.response.data.message.p_out_mssg.includes("expired") ||
                error.response.data.message.p_out_mssg.includes("Invalid token"))))
        ) {
            handleSessionExpiry(); // ðŸ”¥ centralized session expiry handler
        } else {
            Swal.fire({
                title: "Error!",
                text: "Something went wrong while fetching profile details.",
                icon: "error",
                confirmButtonText: "OK"
            });
        }
    });
}




// Function to handle button click and display the stored value
// Function to handle radio button selection and API call

async function displayRadioButton() {
    const radios = document.getElementsByName('utrr');
    let selectedValue = 'None';

    for (let radio of radios) {
        if (radio.checked) {
            selectedValue = radio.value;
            break;
        }
    }

    const val = {
        id: localStorage.getItem('mId'),
        matri_id: localStorage.getItem('matriId'),
        status: selectedValue,
    };

    try {
        const response = await axios.post(`${BASE_URL}/profile_status.php`, val, {
            headers: {
                'Content-Type': 'application/json',
                "Authorization": "Bearer " + localStorage.getItem("jwtToken")
            }
        });

        if (response.data.message && response.data.message.p_out_mssg_flg === 'Y') {
            const profileStatus = response.data.profile_status || val.status;
            localStorage.setItem('profile_status', profileStatus);

            await Swal.fire({
                title: "Success!",
                text: "Profile status updated successfully.",
                icon: "success",
                confirmButtonText: "OK",
            });
        } else {
            await Swal.fire({
                title: "Error!",
                text: "Failed to update profile status.",
                icon: "error",
                confirmButtonText: "OK",
            });
        }
    } catch (error) {
        console.error('Error:', error);

        // âœ… Use handleSessionExpiry for token errors
        if (
            error.response &&
            (error.response.status === 401 ||
                (error.response.data && (
                    error.response.data.message === "Session expired. Please log in again." ||
                    error.response.data.message.startsWith("Invalid token")
                )))
        ) {
            await handleSessionExpiry();
        } else {
            await Swal.fire({
                title: "Error!",
                text: "Failed to update profile status.",
                icon: "error",
                confirmButtonText: "OK",
            });
        }
    }
}

// Function to restore the checked state on page load
function restoreRadioButtonState() {
    const savedStatus = localStorage.getItem('profile_status');
   //consolelog('Saved Status:', savedStatus);

    const radios = document.getElementsByName('utrr');
   //consolelog('Radio buttons found:', radios.length); // This should show the actual number of radio buttons

    if (savedStatus) {
        for (let radio of radios) {
           //consolelog(`Radio value: ${radio.value}, Expected value: ${savedStatus}`);
            if (String(radio.value) === String(savedStatus)) {
                radio.checked = true;
               //consolelog(`Radio button with value ${radio.value} is now checked`);
                return; 
            }
        }
       //consolewarn('No matching radio button found for saved status:', savedStatus);
    }
}

function setDefaultRadioButton() {
    const defaultStatus = localStorage.getItem('profile_status'); // Define the default value you want (e.g., "1" for "Active")
   //consolelog("defaultStatus",defaultStatus);
    // Set the default radio button to checked
    const defaultRadio = document.querySelector(`input[name="utrr"][value="${defaultStatus}"]`);
   //consolelog("defaultStatus",defaultRadio);
    if (defaultRadio) {
        defaultRadio.checked = true;
    }

    // Optionally save the default value to localStorage
    //localStorage.setItem('profile_status', defaultStatus);
}

// Call this function when the page loads
//document.addEventListener('DOMContentLoaded', restoreRadioButtonState);

       // Function to load section details dynamically
       
       function loadSectionDetails(section) {
            
            let heightInCm = parseFloat(myProfileNew.height);

            // Convert to feet and inches
            let heightInFeet = heightInCm / 30.48;
            let feet = Math.floor(heightInFeet);
            let inches = Math.round((heightInFeet - feet) * 12);
            let profileCreator='';
            
            const sectionData = {
                basic: `
                

<div class="profile-basic">
    <button 
    class="option-button" 
    data-section="edit" 
    id="edit" 
    onClick="openPageAndPostMessage()" 
    >
    Edit
</button>
    <div class="profile-item1">
        <strong class="profile-label1">Date of Birth:</strong>
        <span id="dob">${moment(myProfileNew.dob).format("DD-MMM-YYYY")}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Phone No:</strong>
        <span id="phone">${myProfileNew.phone}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Email:</strong>
        <span id="email">${myProfileNew.email}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Profile Creator:</strong>
        <span id="profileCreator">${myProfileNew.creator_name}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Profile Created Date:</strong>
        <span id="profileCreatedDate">${moment(myProfileNew.created_date).format("DD-MMM-YYYY hh:mm:ss")}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Profile Creating For:</strong>
        <span id="profileCreatingFor">${myProfileNew.profile_for}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Profile Creating Phone:</strong>
        <span id="profileCreatingPhone">${myProfileNew.creator_phone}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Marital Status:</strong>
        <span id="maritalStatus">${myProfileNew.status}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Sub Caste:</strong>
        <span id="subCaste">${myProfileNew.sub_caste}</span>
    </div>
</div>

                `,
                additional: `
                
                
                    <div class="profile-basic">
                                <button 
             class="option-button" 
             data-section="edit" 
             id="edit" 
             onClick="openEditAdditional()">
             Edit
          </button>
    <div class="profile-item1">
        <strong class="profile-label1">Height:</strong>
        <span id="profileHeight">${parseInt(myProfileNew.height)+"cm"}</span>
        
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Weight:</strong>
        <span id="profileWeight">${myProfileNew.weight}Kg</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Complexion:</strong>
        <span id="profileComplexion">${myProfileNew.complexion}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Blood Group:</strong>
        <span id="profileBloodGroup">${myProfileNew.blood_group}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Disability:</strong>
        <span id="disability">${myProfileNew.disability}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Country:</strong>
        <span id="profileCountry">${myProfileNew.country}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">State:</strong>
        <span id="profileState">${myProfileNew.state}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">City:</strong>
        <span id="profileCity">${myProfileNew.city}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Address:</strong>
        <span id="profileAddress">${myProfileNew.address}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Remarks:</strong>
        <span id="profileRemarks">${myProfileNew.remark}</span>
    </div>
</div>

                `,
                education: `
                    <div class="profile-basic">
                                <button 
             class="option-button" 
             data-section="edit" 
             id="edit" 
             onClick="openEditEducation()">
             Edit
          </button>
    <div class="profile-item1">
        <strong class="profile-label1">Qualification:</strong>
        <span id="qualification1">${myProfileNew.qualification}</span>
        
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Specialization:</strong>
        <span id="specialization">${myProfileNew.specialization}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Profession:</strong>
        <span id="profession">${myProfileNew.occupation}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Company:</strong>
        <span id="company">${myProfileNew.company}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Company City:</strong>
        <span id="companyCity">${myProfileNew.company_city}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Salary:</strong>
        <span id="salaryRange">${myProfileNew.salary}</span>
    </div>
</div>

                `,
                horoscope: `
                            <div class="profile-basic">
                                         <button 
             class="option-button" 
             data-section="edit" 
             id="edit" 
             onClick="openEditHoroscope()">
             Edit
          </button>
    <div class="profile-item1">
        
        <strong class="profile-label1">Nakshatra:</strong>
        <span id="nakshatra">${myProfileNew.nakshatra}</span>
        
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Rashi:</strong>
        <span id="rashi">${myProfileNew.rashi}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Gothra:</strong>
        <span id="gothra">${myProfileNew.gothra}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Birth Place:</strong>
        <span id="bplace">${myProfileNew.birth_place}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Birth Time:</strong>
        <span id="bTime">${myProfileNew.birth_time}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Family Diety:</strong>
        <span id="familyDiety">${myProfileNew.family_diety}</span>
    </div>
</div>

                `,
                family: `
                    <div class="profile-basic">
                                <button 
             class="option-button" 
             data-section="edit" 
             id="edit" 
             onClick="openEditFamily()">
             Edit
          </button>
               <div class="profile-item1">
        <strong class="profile-label1">No. of kids:</strong>
        <span id="kids">${myProfileNew.kids}</span>
        
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Father's Name:</strong>
        <span id="fatherName">${myProfileNew.father_name}</span>
        
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Father's Occupation:</strong>
        <span id="fatherOccupation">${myProfileNew.father_ocupation}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Mother's Name:</strong>
        <span id="motherName">${myProfileNew.mother_name}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Mother's Occupation:</strong>
        <span id="motherOccupation">${myProfileNew.mother_occupation}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">No of Brother's:</strong>
        <span id="brothers">${myProfileNew.number_of_brothers}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">No of Sister's:</strong>
        <span id="sisters">${myProfileNew.number_of_sisters}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Permanent Address:</strong>
        <span id="pAddress">${myProfileNew.home_town}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Mother Tongue:</strong>
        <span id="motherTongue">${myProfileNew.mother_tongue}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Family Type:</strong>
        <span id="familyType">${myProfileNew.family_type}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Reference Name:</strong>
        <span id="referenceName">${myProfileNew.reference}</span>
    </div>
    <div class="profile-item1">
        <strong class="profile-label1">Reference Number:</strong>
        <span id="referenceNumber">${myProfileNew.reference_number}</span>
    </div>
</div>

                `,
                photo: `
                            <button 
             class="option-button" 
             data-section="edit" 
             id="edit" 
             onClick="openEditPhoto()">
             Upload
          </button>
                        <div class="photo-row">
                        ${getPhotoHTML(photos_url)}
                        </div>
                        `,


                        
                        
                        
                        
                        
                        
                        
                        delete: `
                            <div>
                            <input type="radio" id="r1" name="utrr" value="1">
                            <label for="r1">Active</label><br><br>

                            <input type="radio" id="r2" name="utrr" value="2">
                            <label for="r2">Married</label><br><br>

                            <input type="radio" id="r3" name="utrr" value="3">
                            <label for="r3">Not Interested</label><br><br>

                            <input type="radio" id="r4" name="utrr" value="4">
                            <label for="r4">Delete</label><br><br>

                            <button class="option-button-sub" id="delete1" onclick="displayRadioButton()">Submit</button> 
                            </div> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
                        `,
                        
                        
                        
                        
                        
            };
            
            
            
            detailsSection.innerHTML = sectionData[section] || "<p>No details available for this section.</p>";
             // Initialize zoom functionality after the section is loaded
             if (section === 'photo') {
                 initZoom();
             }


             if (section === 'delete') {
                 setDefaultRadioButton();
             }
            
           }

// Function to update progress bar

// let baseURL='';
document.addEventListener('DOMContentLoaded', function () {
    const waitingDialog = document.getElementById('waiting-dialog');

    // âœ… Logout if no valid matriId
    if (
        !localStorage.getItem('matriId') ||
        localStorage.getItem('matriId') === 'NULL' ||
        localStorage.getItem('matriId') === ''
    ) {
        logout();
        return;
    }

    // âœ… Global session expiry handler
    function handleSessionExpiry(error) {
        if (
            error.response &&
            (error.response.status === 401 ||
                (error.response.data &&
                    (error.response.data.message === "Token expired" ||
                        error.response.data.message === "Invalid token" ||
                        error.response.data.message === "Authorization header missing")))
        ) {
            Swal.fire({
                title: "Session Expired",
                text: "Your session has expired. Please log in again.",
                icon: "warning",
                confirmButtonText: "OK"
            }).then(() => {
                localStorage.clear();
                window.location.href = "Login";
            });
            return true;
        }
        return false;
    }

    // âœ… Waiting dialog helpers
    function showWaitingDialog() {
        waitingDialog.style.display = 'flex';
    }
    function hideWaitingDialog() {
        waitingDialog.style.display = 'none';
    }

    // âœ… Load profile section
    async function loadSectionRow() {
        document.getElementById("optionsRow").style.display = "flex";
    }

    // âœ… Prepare data
    const data = {
        id: localStorage.getItem('mId'),
        matri_id: localStorage.getItem('matriId')
    };

    showWaitingDialog();

    // âœ… Fetch user profile
    axios.post(`${BASE_URL}/my_profile.php`, data, {
        headers: {
            'Content-Type': 'application/json',
            "Authorization": "Bearer " + localStorage.getItem("jwtToken")
        }
    })
    .then(function (response) {
            hideWaitingDialog();
            const res = response.data;
        if (res.token) {
        localStorage.setItem("jwtToken", res.token);
    }

        if (res.message && res.message.p_out_mssg_flg === 'Y' && res.dataout && res.dataout.length > 0) {
            localStorage.setItem("matriId", response.data.dataout[0].matri_id);
            // localStorage.setItem("baseURL", response.data.my_profile[0].base_url);
            
            // NOTE: profilePicture and profileImg are not in this HTML, skipping update for them.
            // const image = document.getElementById("profilePicture");
            // image.src = localStorage.getItem("baseURL")+response.data.dataout[0]["url"];
            
            // NOTE: profileFor/profileId are not in this HTML, skipping update for them.
            
           //consolelog(response.data.dataout);
                let myProfile=response.data.dataout[0];
                myProfileNew=response.data.dataout[0];
                
                // ðŸš© FIX: Ensure Name is displayed
                document.getElementById("profileNameText").textContent = `${(myProfile.first_name==null || myProfile.first_name=='null')?'':myProfile.first_name+" "+myProfile.last_name}`;
                
                document.getElementById("profileAge").textContent = `${(myProfile.age==null || myProfile.age=='null')?'':myProfile.age+"yrs"}`;
                document.getElementById("profileHeight").textContent = `${(myProfile.height==null || myProfile.height=='null')?'': myProfile.height+"cm"}`;
                document.getElementById("profileWeight").textContent = `${(myProfile.weight==null || myProfile.weight=='null')?'':myProfile.weight+"kg"}`;
             
                let imgURL='';
                if(myProfile.gender_type==='Male' && (myProfile.url===null || myProfile.url==='')){
                    imgURL='../img/2.png';
                }else if(myProfile.gender_type==='Female' && (myProfile.url===null || myProfile.url==='')){
                    imgURL='../img/1.png';
                }else{  
                    imgURL=localStorage.getItem("baseURL")+myProfile.url;
                }
                document.getElementById("profilePhoto").src = imgURL;
                
                // ðŸš© FIX: Ensure Matri ID is displayed
                const matriText=document.getElementById("matriText");
                matriText.textContent=myProfile.matri_id;

            
            
            
            let baseURL=response.data.dataout[0].base_url;
            loadSectionRow();      

            loadSectionDetails('basic');


        } else {
            Swal.fire({
                title: "Error!",
                text: "Failed to load your profile details. Please try again later.",
                icon: "error",
                confirmButtonText: "OK"
            });
        }
    })
    .catch(function (error) {
            hideWaitingDialog(); 
        console.error("Profile fetch error:", error);
        if (!handleSessionExpiry(error)) {
            Swal.fire({
                title: "Error!",
                text: "Unable to fetch profile information.",
                icon: "error",
                confirmButtonText: "OK"
            });
        }
    })
    .finally(hideWaitingDialog);


    const photo = {
        matri_id: localStorage.getItem('matriId'),
        type: "get_image",
    };

    axios.post(`${BASE_URL}/edit_image.php`, photo, {
        headers: {
            'Content-Type': 'application/json',
            "Authorization": "Bearer " + localStorage.getItem("jwtToken")
        }
    })
    .then(function (response) {
        const res = response.data;
            if (res.token) {
        localStorage.setItem("jwtToken", res.token);
    }
        if (res.message && res.message.p_out_mssg_flg === 'Y') {
            const dataout = res.dataout || [];
            if (dataout.length > 0) {
                photos_url = dataout.map(item => ({
                    url: localStorage.getItem("baseURL") + (item.url || ""),
                    sl_id: item.sl_id || ""
                }));
            } else {
                // If there are no photos, photos_url is empty array, which is fine.
            }
        } else {
            // Error loading photos, but don't show an error, just log it.
            console.error("Failed to load profile images.");
        }
    })
    .catch(function (error) {
        console.error("Image fetch error:", error);
        if (!handleSessionExpiry(error)) {
             // Non-critical error, no big popup needed
        }
    });

    // âœ… Safe helper functions
    function setText(id, value) {
        const el = document.getElementById(id);
        if (el) el.textContent = value || '';
    }

    function setSrc(id, src) {
        const el = document.getElementById(id);
        if (el) el.src = src || '../img/default.png';
    }
});



</script>
</body>
</html>
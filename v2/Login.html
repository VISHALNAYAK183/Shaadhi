<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bunts Matrimony - Login</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

<style>
:root {
  --primary: #E3425B;
  --primary-dark: #ea4a57;
}
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: "Inter", system-ui, sans-serif;
  background: url("../img/background.jpg") 40% center / cover no-repeat fixed; 
  height: 100vh; 
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  overflow: hidden; 
  position: relative;
}

body::before {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(255 255 255 / 59%);
  /* backdrop-filter: blur(1px); */
  z-index: 0;
}

header {
  background: rgba(255, 255, 255, 0.98);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0px 1%;
  position: sticky;
  top: 0;
  z-index: 10;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
}

.logo-group img { height: 90px; }

header .actions {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
}
header .btn-register {
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 9px 18px;
  border-radius: 30px;
  font-weight: 700;
  cursor: pointer;
  transition: .3s;
}
header .btn-register:hover { background: var(--primary-dark); }

.hero {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 60px;
  padding: 40px 8%;
  position: relative;
  flex-wrap: wrap;
  z-index: 2;
}

.hero-left img {
  max-width: 600px;
  width: 100%;
  height: auto;
  z-index: 2;
  position: relative;
  left: -190px;
}

.hero::after {
  content: "";
  position: absolute;
  right: -400px;
  top: 60%;
  transform: translateY(-50%) scaleX(-1);
  width: 1500px;
  height: 1250px;
  background: url("../img/Bunts matrimony_Final-06.png") no-repeat center/contain;
  z-index: 1;
}


.hero-right {
  display: flex;
  flex-direction: column;
  align-items: center;
  z-index: 2;
}

.login-card {
  background: rgba(255, 255, 255, 0.759);
  /* backdrop-filter: blur(18px); */
  border-radius: 18px;
  padding: 25px 28px;
  max-width: 440px;
  width: 100%;
  box-shadow: 0 20px 45px rgba(0, 0, 0, 0.658);
  z-index: 2;
  position: relative;
}

.login-card h2 {
  text-align: center;
  color: #000;
  font-weight: 800;
  font-size: 20px;
  margin-bottom: 6px;
}
.login-card p {
  text-align: center;
  color: #444;
  font-size: 13px;
  margin-bottom: 14px;
}

.form-group { margin-bottom: 10px; }

.form-group input {
  width: 100%;
  padding: 9px 12px;
  border: 1px solid #eee;
  border-radius: 10px;
  font-size: 14px;
  background: rgba(255, 255, 255, .95);
  color: #111;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.12);
}
/* .form-group input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(227, 66, 91, .25);
} */

.captcha {
  display: flex;
  align-items: center;
  gap: 8px;
}
.captcha-box {
  background: #fff;
  border: 1px #ccc;
  border-radius: 8px;
  padding: 8px 12px;
  font-weight: 700;
  font-size: large;
  letter-spacing: 2px;
  font-family: monospace;
  box-shadow: 0 3px 6px rgb(0 0 0 / 47%);
}
.refresh-btn {
  border: none; background: none; color: var(--primary);
  cursor: pointer; font-size: 18px;
}
.refresh-btn:hover { color: var(--primary-dark); }

.btn {
  display: block;
  width: 60%;
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 10px 0;
  font-weight: 700;
  cursor: pointer;
  margin-top: 10px;
  box-shadow: 0 8px 20px -8px rgba(227, 66, 91, .45);
}
.btn:hover { background: var(--primary-dark); }

.divider {
  display: flex;
  align-items: center;
  justify-content: center;
  color: #000000;
  font-size: 12px;
  margin: 10px 0;
}
.divider::before, .divider::after {
  content: "";
  flex: 1;
  height: 1px;
  background: #000000;
  margin: 0 10px;
  color: #000;
}

.forgot { text-align: right; margin-top: 4px; }
.forgot a { color: var(--primary); font-size: 13px; text-decoration: none; }
.forgot a:hover { text-decoration: underline; }

/* ✅ I agree section now sits exactly below the card */
.agree {
  text-align: center;
  margin-top: 15px;
  color: #333;
  font-size: 14px;
  font-weight: 500;
  z-index: 5;
  position: relative;
}
.agree a {
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
}
.agree a:hover { text-decoration: underline; }



#otp-input-container {
  display: none;
}
@media (max-width: 992px) {
  body {
    height: auto;
    overflow-y: auto; /* Allow scroll only on mobile */
  }
  .hero { flex-direction: column; padding: 40px 6%; }
  .hero::after { display: none; }
  .login-card { width: 90%; }
  .hero-left img { max-width: 80%; }
}


</style>
</head>

<body>
  <header>
    <div class="logo-group">
      <img src="../img/buntslogo.jpg" alt="Bunts Logo" height="60" />
    </div>
    <div class="actions">
      <span>Don't have an account?</span>
      <button class="btn-register" onclick="location.href='Signup'">REGISTER</button>
    </div>
  </header>

  <section class="hero">
    <div class="hero-left">
      <img src="../img/kannadaText.png" alt="ಹೃದಯಗಳಿಗೆ ಸೇತುವೆ" />
    </div>

    <div class="hero-right">
      <div class="login-card">
        <h2>Login with Password</h2>
        <p>Sign in to your account</p>

        <div class="form-group">
          <input type="text" id="phone-email" placeholder="Enter your phone/ Matri ID" />
          <div id="phoneErrorMessage" class="error"></div>
        </div>

        <div class="form-group">
          <input type="password" id="password" placeholder="Enter your password" />
          <div class="forgot"><a href="forgot_password">Forgot Password?</a></div>
          <div id="passwordErrorMessage" class="error"></div>
        </div>

        <div class="form-group captcha">
          <div class="captcha-box" id="captchaValue">000000</div>
          <button class="refresh-btn" onclick="generateCaptcha()"><i class="fa-solid fa-rotate-right"></i></button>
          <input type="text" id="captchaInput" placeholder="Enter CAPTCHA"  style="box-shadow: 0 3px 6px rgb(0 0 0 / 47%);"">
        </div>
        <div class="error" id="errorMessage"></div>

        <button class="btn" onclick="loginWithPassword()">LOGIN</button>

        <div class="divider">OR</div>

        <h2>Login with OTP</h2>
        <p>Quick and secure access</p>
        <div class="form-group">
          <input type="text" id="otp-phone-email" placeholder="Enter 10-digit phone number" />
          <div id="phoneOTPErrorMessage" class="error"></div>
        </div>
        <button class="btn" id="generate-otp" onclick="generateOtp()">Generate OTP</button>

        <div id="otp-input-container">
          <div class="form-group">
          <input type="text" id="otp" placeholder="Enter 4-digit OTP" maxlength="4" pattern="\d{4}" inputmode="numeric" />
            <a href="#" id="resend-otp" style="display:none" onclick="resendOtp()">Resend OTP</a>
          </div>
          <button class="btn" onclick="loginWithOtp()">Verify & Login</button>
          <p id="otp-timer"></p>
        </div>
      </div>

      <div class="agree">
        <label><input type="checkbox" id="terms" checked> I agree to the 
          <a href="term">terms and privacy policy</a></label><br>
        For any Query / Support <a href="support">Click here</a>
      </div>
    </div>
  </section>

  <div id="loader" class="loader-container">
    <div class="loading-text">Loading</div>
    <div class="dots">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="baseurl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <script>
    // Reused from old version
    const OTP_TIMEOUT_DURATION = 30;
    let otpTimeout;
    let correctOtp = "";
    let currentCaptcha = "";

    function generateCaptcha() {
      const chars = "0123456789";
      let captcha = "";
      for (let i = 0; i < 6; i++) captcha += chars.charAt(Math.floor(Math.random() * chars.length));
      currentCaptcha = captcha;
      document.getElementById("captchaValue").textContent = captcha;
    }

    window.onload = generateCaptcha;

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function isValidPhone(phone) {
      return /^(\+?\d{1,3})?(\d{10})$/.test(phone);
    }

    function handleLoginSuccess() {
      if (!document.getElementById("terms").checked) {
        Swal.fire({
          icon: "info",
          title: "Agree to Terms",
          text: "You must agree before login.",
        });
        return;
      }

      Swal.fire({
        icon: "success",
        title: "Login Successful!",
        text: "Welcome to Bunts Matrimony",
        showConfirmButton: false,
        timer: 2000
      }).then(() => window.location.href = "dashboard");
    }

    function loginWithPassword() {
      const user = document.getElementById("phone-email").value.trim();
      const password = document.getElementById("password").value.trim();
      const captchaInput = document.getElementById("captchaInput").value.trim();

      if (!user || !password) {
        Swal.fire("Missing Fields", "Enter valid details", "warning");
        return;
      }

      if (captchaInput !== currentCaptcha) {
        Swal.fire("Invalid CAPTCHA", "Please try again.", "error");
        generateCaptcha();
        return;
      }

      document.getElementById("loader").style.display = "flex";
      fetch(`${BASE_URL}/login.php`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ user, password })
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("loader").style.display = "none";
        if (data.dataout[0].p_out_mssg_flg === "Y") {
          const token = data.dataout[0].token;
          localStorage.setItem("jwtToken", token);
          const decoded = jwt_decode(token);
          localStorage.setItem("matriId", decoded.data.matri_id);
          localStorage.setItem("phone", decoded.data.phone);
          handleLoginSuccess();
        } else {
          Swal.fire("Login Failed", data.dataout[0].p_out_mssg, "error");
        }
      })
      .catch(() => {
        document.getElementById("loader").style.display = "none";
        Swal.fire("Server Error", "Please try again later.", "error");
      });
    }

    function generateOtp() {
      const phone = document.getElementById("otp-phone-email").value.trim();
      if (!isValidPhone(phone)) {
        Swal.fire("Invalid", "Enter valid 10-digit phone number.", "warning");
        return;
      }

      axios.post(`${BASE_URL}/login.php`, { user: phone })
      .then(res => {
        if (res.data.dataout[0].p_out_mssg_flg === "Y") sendSMS();
        else Swal.fire("User not found", "Please try again.", "error");
      });
    }

    function sendSMS() {
      const number = document.getElementById("otp-phone-email").value.trim();
      fetch(`${BASE_URL}/send_sms.php`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ number, type: "otp" })
      })
      .then(res => res.json())
      .then(data => {
        if (data.message.p_out_mssg_flg === "Y") {
          correctOtp = data.data.Otp;
          document.getElementById("otp-input-container").style.display = "block";
          document.getElementById("generate-otp").style.display = "none";
          startOtpTimer();
          Swal.fire("Success", "OTP sent successfully!", "success");
        }
      });
    }

    function startOtpTimer() {
      let timeLeft = OTP_TIMEOUT_DURATION;
      document.getElementById("otp-timer").innerText = `You can request new OTP in ${timeLeft}s`;
      otpTimeout = setInterval(() => {
        timeLeft--;
        document.getElementById("otp-timer").innerText = `You can request new OTP in ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(otpTimeout);
          document.getElementById("otp-timer").innerText = "";
          document.getElementById("resend-otp").style.display = "inline";
        }
      }, 1000);
    }

    function resendOtp() {
      clearInterval(otpTimeout);
      document.getElementById("resend-otp").style.display = "none";
      generateOtp();
    }

  function loginWithOtp() {
  const otp = document.getElementById("otp").value.trim();
  const phone = document.getElementById("otp-phone-email").value.trim();

 if (!/^\d{4}$/.test(otp)) {
  Swal.fire("Invalid OTP", "Please enter a valid 4-digit numeric OTP.", "warning");
  return;
}


  if (CryptoJS.MD5(otp).toString() !== correctOtp) {
    Swal.fire("Invalid OTP", "Please try again.", "error");
    return;
  }

  document.getElementById("loader").style.display = "flex";

  fetch(`${BASE_URL}/login.php`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ user: phone, otp })
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById("loader").style.display = "none";

    if (data.dataout[0].p_out_mssg_flg === "Y") {
     
      const token = data.dataout[0].token;
      localStorage.setItem("jwtToken", token);
      const decoded = jwt_decode(token);
      localStorage.setItem("matriId", decoded.data.matri_id);
      localStorage.setItem("phone", decoded.data.phone);

      handleLoginSuccess(); 
    } else {
      Swal.fire("Failed", data.dataout[0].p_out_mssg || "OTP Verification Failed", "error");
    }
  })
  .catch(() => {
    document.getElementById("loader").style.display = "none";
    Swal.fire("Server Error", "Please try again later.", "error");
  });
}

  </script>
</body>
</html>